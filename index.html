<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
<a-scene mindar-image="imageTargetSrc: assets/targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <a-assets>
        <a-asset-item id="sahur-model" src="https://store.clipboardapp.org/tt/Sahur_v09.glb"></a-asset-item>
        <audio id="sahur-sound" src="https://store.clipboardapp.org/tt/Sahur_FX_250827.wav" preload="auto"></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
        <a-gltf-model
            id="sahur-gltf"
            rotation="90 0 0"
            position="0 0 0.1"
            scale="1 1 1"
            src="#sahur-model"
            animation-mixer
        ></a-gltf-model>
    </a-entity>

    <script>
        const targetEntity = document.querySelector("#target-entity");
        const sahurSound = document.querySelector("#sahur-sound");
        const sahurModel = document.querySelector("#sahur-gltf");

        let isPlaying = false;

        // animation-mixer 컴포넌트가 준비될 때까지 대기
        sahurModel.addEventListener('model-loaded', () => {
            console.log("Model loaded");
            const mixer = sahurModel.components['animation-mixer'];
            if (mixer && mixer.mixer) {
                // 초기에는 일시정지
                mixer.mixer.timeScale = 0;
            }
        });

        targetEntity.addEventListener("targetFound", event => {
            console.log("Target found");
            if (!isPlaying) {
                const mixerComponent = sahurModel.components['animation-mixer'];
                if (mixerComponent && mixerComponent.mixer) {
                    const mixer = mixerComponent.mixer;
                    const actions = mixer._actions;

                    if (actions && actions.length > 0) {
                        const action = actions[0];

                        // 애니메이션 리셋 및 재생
                        action.reset();
                        action.play();
                        mixer.timeScale = 1;

                        // 사운드 리셋 및 재생
                        sahurSound.currentTime = 0;
                        sahurSound.play();

                        isPlaying = true;
                    }
                }
            }
        });

        targetEntity.addEventListener("targetLost", event => {
            console.log("Target lost");

            const mixerComponent = sahurModel.components['animation-mixer'];
            if (mixerComponent && mixerComponent.mixer) {
                // 애니메이션 정지
                mixerComponent.mixer.timeScale = 0;
            }

            // 사운드 정지
            sahurSound.pause();
            sahurSound.currentTime = 0;

            isPlaying = false;
        });
    </script>
</a-scene>
</body>
</html>